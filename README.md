# プロジェクト概要
コネクテッドカーシステムにおける、ある課題を再現するための簡易的な環境です。

コネクテッドカーシステムはスマホアプリ、リバースプロキシサーバ、アプリケーションサーバ、車の4つのコンポーネントから構成されています。

また、それとは別に、AIエージェントシステムが存在します。これはコネクテッドカーシステムで発生した課題を、ソースコード&設定ファイル&各コンポーネントの実行ログが統合されたファイルを分析することで原因を突き止め、修復プランを生成する役割を果たします。

# ディレクトリ構成
```
D:.
│ .gitignore
│ docker-compose.yaml
│ README.md
│
├─ai_agent
│ main.py
│ requirements.txt
│
├─car_app
│ send_command.py
│
├─cloud_api
│ main.py
│
├─logs
│ app.log
│ monitor.log
│
├─nginx
│ nginx.conf
│
└─vehicle_simulator
  simulator.py
```
`ai_agent`はAIエージェントシステムを指します。`car_app`はスマホアプリ、`nginx`はリバースプロキシサーバ、`cloud_api`はアプリケーションサーバ、`vehicle_simulator`は車を指します。

# 実行手順（起動・ログ収集・実行状態の取得）

このREADMEは、アプリケーションの起動方法、実行ログの収集方法、そして `cloud_api/main.py` の処理状況（メトリクス）をAPIで取得する方法をまとめたものです。

## 前提

- Docker / Docker Compose が利用できること
- リポジトリ直下でコマンドを実行すること
- `./logs` ディレクトリが存在すること（ない場合は作成）

```
mkdir -p ./logs
```

## 1. アプリケーション起動とログ収集
ターミナルを2つ開きます。

### ターミナル1（アプリ起動）
4つのアプリケーションコンテナをバックグラウンドで起動します。
```
docker compose --profile app up --build -d
```

### ターミナル2（ログ収集）
起動したコンテナの全ての出力（標準出力とエラー出力）を`./logs/app.log`にリアルタイムで記録します。
```
docker compose --profile app logs --follow > ./logs/app.log
```
このコマンドはログを監視し続けるため、このターミナルは開いたままにしてください。

## 2. エラーの再現
`send_command.py`は、時間が経つにつれて大量のリクエストを送信し、システムに負荷をかけてタイムアウトエラーを発生させるように作られています。
- ターミナル2のログを眺めながら、**1〜2分ほど待機**してください。
- `Client: ... ERROR! Operation timed out.`のようなエラーログが`app.log`に記録されるはずです。

## ログ収集の停止とアプリ終了
エラーログが十分に記録されたら、以下の順で停止します。
**1.ターミナル2（ログ監視停止）**
`Ctrl + C`を押してログ監視を停止します。これで`./logs/app.log`への書き込みが完了します。

**2.ターミナル1（アプリ停止・削除）**
4つのアプリケーションコンテナを停止・削除します。
```
docker compose --profile app down
```

## 3. AIエージェントによる分析
AIエージェントは4つのコンポーネントとは独立しています。AIエージェントを起動します（ai_agent コンテナが起動し、main.py が実行されます）。
```
docker compose --profile agent up --build
```
エージェントは自動的に以下を読み込み、分析を開始します。
- 各コンポーネントのソースコード。現在はリバースプロキシサーバとアプリケーションサーバのソースコードのみを読み込むようになっている。
- `./logs/app.log`
処理が完了すると、ターミナルに以下が出力されます。
- エラーの根本原因の分析結果
- 具体的なコード修復案

## 4. (その他) 実行状態をAPIで取得
`cloud_api/main.py`での処理状況を確認したい場合は、ターミナル1でコンテナが動作している状態で、別ターミナルを開き次のAPIを叩きます。ディレクトリは同じです
**Windows（例：PowerShell / CMD）**
```
curl -s http://localhost:8080/metrics
```
**出力例**
- 現在の処理状況
- リクエスト数
- エラー数